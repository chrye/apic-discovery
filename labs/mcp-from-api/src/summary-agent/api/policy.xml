<policies>
    <inbound>
        <base />
        <return-response>
            <set-status code="200" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>@{
                    var body = context.Request.Body.As<JObject>(preserveContent: true);
                    var text = body?.Value<string>("text") ?? "";

                    // Count words by splitting on whitespace
                    char[] ws = new char[] { ' ', (char)9, (char)10, (char)13 };
                    var words = text.Split(ws, StringSplitOptions.RemoveEmptyEntries);
                    var originalWordCount = words.Length;

                    // Take roughly the first third of sentences as a summary
                    string[] delims = new string[] { ". ", "! ", "? " };
                    var sentences = text.Split(delims, StringSplitOptions.RemoveEmptyEntries);
                    var summaryCount = Math.Max(1, sentences.Length / 3);
                    var summarySentences = sentences.Take(summaryCount);
                    var summary = string.Join(". ", summarySentences);
                    if (!summary.EndsWith(".")) { summary += "."; }

                    var summaryWords = summary.Split(ws, StringSplitOptions.RemoveEmptyEntries).Length;

                    return new JObject(
                        new JProperty("summary", summary),
                        new JProperty("wordCount", summaryWords),
                        new JProperty("originalWordCount", originalWordCount),
                        new JProperty("generatedAt", DateTime.UtcNow.ToString("o"))
                        ).ToString();
                    }</set-body>
        </return-response>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
